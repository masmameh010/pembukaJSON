<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pembuka Koleksi Gambar AI | IMAJINASILOKAL</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e6f7ff 100%);
    }
    .header-gradient {
      background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
    }
    .orange-gradient-btn {
      background: linear-gradient(90deg, #FF8C00 0%, #FFA500 100%); /* Orange gradient */
      transition: all 0.3s ease;
    }
    .orange-gradient-btn:hover {
      background: linear-gradient(90deg, #FFA500 0%, #FFD700 100%); /* Lighter orange on hover */
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(255, 140, 0, 0.4);
    }
    .orange-gradient-btn:active {
      transform: translateY(0);
      box-shadow: none;
    }
    .view-option-btn {
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    .view-option-btn.active {
      border-color: #FF8C00;
      box-shadow: 0 0 0 3px rgba(255, 140, 0, 0.2);
    }
    .gallery-grid-2x2 {
      grid-template-columns: repeat(2, 1fr);
    }
    .gallery-grid-3x3 {
      grid-template-columns: repeat(3, 1fr);
    }
    .gallery-list {
      grid-template-columns: 1fr;
    }
    .gallery-item {
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    .gallery-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    .copy-btn, .copy-icon {
      cursor: pointer;
      transition: all 0.2s;
    }
    .copy-btn:hover, .copy-icon:hover {
      transform: scale(1.1);
      color: #FF8C00;
    }
    .copy-btn:active, .copy-icon:active {
      transform: scale(0.95);
    }
    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .detail-modal {
      animation: modalFadeIn 0.3s ease-out;
    }
    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .hidden {
      display: none;
    }
    /* Custom Toast Notification */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #2d3748;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s, transform 0.3s;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-20px);
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <!-- Header -->
    <header class="mb-8 text-center">
      <div class="header-gradient text-white py-6 px-4 rounded-2xl shadow-lg mb-4">
        <h1 class="text-3xl md:text-4xl font-bold mb-2">
          <i class="fa-solid fa-image mr-2"></i>
          KOLEKSI GAMBAR AI
        </h1>
        <p class="text-indigo-100 text-lg">by IMAJINASILOKAL</p>
      </div>
      <p class="text-gray-600 max-w-2xl mx-auto">
        Lihat dan kelola koleksi gambar AI Anda dengan mudah.
      </p>
    </header>

    <!-- Import JSON Section -->
    <div class="bg-white rounded-2xl shadow-xl mb-8 overflow-hidden p-5">
      <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
        <i class="fa-solid fa-file-import"></i>
        Impor Koleksi dari JSON
      </h2>
      <div class="flex flex-col md:flex-row items-center gap-4">
        <input type="file" id="importInput" accept="application/json" class="hidden">
        <button type="button" id="importBtn" class="orange-gradient-btn w-full md:w-auto px-6 py-3 text-white rounded-xl font-medium flex items-center justify-center gap-2">
          <i class="fa-solid fa-upload"></i>
          Pilih File JSON
        </button>
        <span id="fileNameDisplay" class="text-gray-600 italic">Belum ada file dipilih.</span>
      </div>
    </div>

    <!-- Gallery Controls -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
      <h2 class="text-2xl font-bold flex items-center gap-2">
        <i class="fa-solid fa-images text-indigo-600"></i>
        Galeri Koleksi
      </h2>
      <div class="flex flex-wrap gap-3 items-center">
        <!-- View Options -->
        <div class="flex rounded-lg border border-gray-300 overflow-hidden">
          <button id="viewGrid2x2" class="view-option-btn px-4 py-2 text-gray-700 bg-gray-100 active" title="Grid 2x2">
            <i class="fa-solid fa-th-large"></i>
          </button>
          <button id="viewGrid3x3" class="view-option-btn px-4 py-2 text-gray-700 bg-gray-100" title="Grid 3x3">
            <i class="fa-solid fa-grip"></i>
          </button>
          <button id="viewList" class="view-option-btn px-4 py-2 text-gray-700 bg-gray-100" title="List View">
            <i class="fa-solid fa-list"></i>
          </button>
        </div>
        <!-- Search Input -->
        <div class="relative flex-grow">
          <input type="text" id="searchInput" placeholder="Cari prompt atau judul..." class="pl-10 pr-4 py-2 border rounded-lg w-full">
          <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </div>
      </div>
    </div>
    
    <!-- Gallery -->
    <div id="gallery" class="grid gap-5 gallery-grid-2x2">
      <!-- Konten galeri akan diisi oleh JavaScript -->
    </div>
    <div id="emptyGallery" class="text-center py-16 text-gray-500 hidden">
        <i class="fa-solid fa-ghost text-5xl mb-4"></i>
        <p class="text-xl">Galeri masih kosong.</p>
        <p>Silakan impor koleksi Anda dari file JSON.</p>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="detailModal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-white rounded-2xl shadow-lg max-w-4xl w-full max-h-[90vh] overflow-auto detail-modal">
      <div class="header-gradient text-white p-5 flex justify-between items-center sticky top-0 z-10">
        <h3 class="text-xl font-bold">Detail Koleksi</h3>
        <button onclick="closeDetailModal()" class="text-white hover:text-gray-200">
          <i class="fa-solid fa-xmark text-2xl"></i>
        </button>
      </div>
      <div class="p-6">
        <div class="flex flex-col lg:flex-row gap-8">
          <!-- Image Column -->
          <div class="lg:w-2/5">
            <img id="detailImage" src="" class="rounded-xl shadow-lg border w-full" onerror="this.onerror=null;this.src='https://placehold.co/500x500/e2e8f0/e2e8f0?text=Gambar+Tidak+Tersedia';">
            <div class="mt-4 flex flex-wrap gap-2">
                <button id="copyImageUrlBtn" class="orange-gradient-btn flex-1 px-4 py-2 text-white rounded-lg font-medium flex items-center justify-center gap-2">
                    <i class="fa-solid fa-link"></i> Salin URL Gambar
                </button>
                <a id="openImageNewTabBtn" href="#" target="_blank" class="orange-gradient-btn flex-1 px-4 py-2 text-white rounded-lg font-medium flex items-center justify-center gap-2">
                    <i class="fa-solid fa-external-link-alt"></i> Buka di Tab Baru
                </a>
            </div>
          </div>
          <!-- Info Column -->
          <div class="lg:w-3/5">
            <div class="space-y-4">
              <!-- Prompt -->
              <div>
                <h4 class="font-semibold text-lg mb-2 flex items-center gap-2"><i class="fa-solid fa-comment"></i>Prompt</h4>
                <p id="detailPrompt" class="text-gray-700 leading-relaxed bg-gray-50 p-3 rounded-lg break-words"></p>
                <button onclick="copyElementText('detailPrompt')" class="orange-gradient-btn mt-2 px-4 py-2 text-white rounded-lg font-medium flex items-center gap-2">
                  <i class="fa-solid fa-copy"></i> Salin Prompt
                </button>
              </div>
              
              <!-- Parameter (Optional, based on your JSON structure) -->
              <div id="detailParametersSection" class="bg-gray-50 rounded-lg p-4 hidden">
                <h4 class="font-semibold text-lg flex items-center gap-2"><i class="fa-solid fa-info-circle"></i>Parameter</h4>
                <div class="mt-3 space-y-2 text-sm" id="detailParametersContent">
                    <!-- Parameters will be injected here -->
                </div>
              </div>

              <div>
                <h4 class="font-semibold text-lg mb-2 flex items-center gap-2"><i class="fa-solid fa-tags"></i>Tags</h4>
                <div id="detailTags" class="flex flex-wrap gap-2"></div>
              </div>
              <div>
                <h4 class="font-semibold text-lg mb-2 flex items-center gap-2"><i class="fa-solid fa-sticky-note"></i>Catatan</h4>
                <p id="detailNotes" class="text-gray-700 bg-gray-50 p-3 rounded-lg min-h-16 break-words"></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast">Pesan notifikasi</div>

  <script>
    // ===================================================================================
    // FUNGSI BANTUAN (HARUS DIDEFINISIKAN SEBELUM DIGUNAKAN)
    // ===================================================================================

    // Fungsi untuk menampilkan notifikasi (toast)
    const showToast = (message) => {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    };

    // Fungsi Salin Teks Universal yang Lebih Andal
    const copyTextToClipboard = (text) => {
        if (!text || typeof text !== 'string') {
            showToast('Tidak ada teks untuk disalin.');
            return;
        }
        
        // Metode modern: Navigator Clipboard API
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Teks berhasil disalin!');
            }).catch(err => {
                console.error('Gagal menggunakan navigator.clipboard:', err);
                fallbackCopy(text); // Coba metode fallback jika gagal
            });
        } else {
            fallbackCopy(text); // Langsung gunakan metode fallback
        }
    };

    const fallbackCopy = (text) => {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.top = "-9999px";
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showToast('Teks berhasil disalin!');
            } else {
                showToast('Gagal menyalin teks.');
            }
        } catch (err) {
            console.error('Gagal menggunakan execCommand:', err);
            showToast('Gagal menyalin teks.');
        }
        document.body.removeChild(textArea);
    };
    
    // Fungsi pembantu untuk menyalin teks dari sebuah elemen berdasarkan ID-nya
    const copyElementText = (elementId) => {
        const element = document.getElementById(elementId);
        if (element && element.textContent) {
            copyTextToClipboard(element.textContent);
        } else {
            showToast('Tidak ada teks untuk disalin.');
        }
    };

    // ===================================================================================
    // FUNGSI UTAMA APLIKASI
    // ===================================================================================

    let collections = [];
    let currentDetailItem = null; // Store the full item for detail view
    let currentView = 'grid-2x2'; // Default view

    // Fungsi untuk menampilkan koleksi di galeri
    const renderGallery = (filteredCollections = collections) => {
      const gallery = document.getElementById('gallery');
      const emptyGallery = document.getElementById('emptyGallery');

      gallery.innerHTML = '';
      if (filteredCollections.length === 0) {
        emptyGallery.classList.remove('hidden');
        gallery.classList.add('hidden');
        return;
      }
      
      emptyGallery.classList.add('hidden');
      gallery.classList.remove('hidden');

      // Apply current view class
      gallery.className = 'grid gap-5'; // Reset classes
      if (currentView === 'grid-2x2') {
        gallery.classList.add('gallery-grid-2x2', 'sm:grid-cols-2', 'md:grid-cols-2', 'lg:grid-cols-2');
      } else if (currentView === 'grid-3x3') {
        gallery.classList.add('gallery-grid-3x3', 'sm:grid-cols-2', 'md:grid-cols-3', 'lg:grid-cols-3');
      } else if (currentView === 'list') {
        gallery.classList.add('gallery-list');
      }

      filteredCollections.forEach((item, index) => {
        // Ensure item.tags is a string before splitting
        const tagsHtml = item.tags && typeof item.tags === 'string' ? item.tags.split(',').map(tag => tag.trim() ? `<span class="badge bg-indigo-100 text-indigo-800">${tag.trim()}</span>` : '').join('') : '';
        
        const galleryItem = document.createElement('div');
        galleryItem.className = 'gallery-item bg-white rounded-xl overflow-hidden border border-gray-200 flex flex-col cursor-pointer';
        // Pass the full item object to showDetail
        galleryItem.onclick = () => showDetail(item); 
        
        let itemContent;
        if (currentView === 'list') {
          itemContent = `
            <div class="flex items-center p-4">
              <img src="${item.imageUrl || 'https://placehold.co/100x100/e2e8f0/e2e8f0?text=X'}" class="w-24 h-24 object-cover rounded-lg mr-4" onerror="this.onerror=null;this.src='https://placehold.co/100x100/e2e8f0/e2e8f0?text=X';">
              <div class="flex-grow">
                <h3 class="font-semibold mb-1">${item.model || 'N/A'}</h3>
                <p class="text-sm text-gray-600 mb-2 line-clamp-2">${item.prompt || 'Tidak ada prompt'}</p>
                <div class="flex flex-wrap gap-1">
                  ${tagsHtml}
                </div>
              </div>
              <div class="ml-4">
                <span class="badge bg-indigo-100 text-indigo-800 capitalize">${item.platform || 'N/A'}</span>
              </div>
            </div>
          `;
        } else {
          itemContent = `
            <div class="relative">
              <img src="${item.imageUrl || 'https://placehold.co/500x500/e2e8f0/e2e8f0?text=X'}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/500x500/e2e8f0/e2e8f0?text=X';">
              <div class="absolute top-2 right-2">
                <span class="badge bg-indigo-100 text-indigo-800 capitalize">${item.platform || 'N/A'}</span>
              </div>
            </div>
            <div class="p-4 flex flex-col flex-grow">
              <h3 class="font-semibold mb-1 truncate">${item.model || 'N/A'}</h3>
              <p class="text-sm text-gray-600 mb-3 flex-grow line-clamp-2">${item.prompt || 'Tidak ada prompt'}</p>
              <div class="flex flex-wrap gap-1 mb-3">
                ${tagsHtml}
              </div>
            </div>
          `;
        }
        galleryItem.innerHTML = itemContent;
        gallery.appendChild(galleryItem);
      });
    };

    // Fungsi untuk menampilkan detail modal
    const showDetail = (item) => {
      const detailModal = document.getElementById('detailModal');
      currentDetailItem = item; // Store the item for copy functions
      if (!item) {
        console.error("Item detail is null or undefined.");
        return;
      }

      document.getElementById('detailImage').src = item.imageUrl || 'https://placehold.co/500x500/e2e8f0/e2e8f0?text=Gambar+Tidak+Tersedia';
      document.getElementById('detailPrompt').textContent = item.prompt || 'Tidak ada prompt.';
      document.getElementById('detailNotes').textContent = item.notes || 'Tidak ada catatan.';
      
      const tagsContainer = document.getElementById('detailTags');
      tagsContainer.innerHTML = item.tags && typeof item.tags === 'string' ? item.tags.split(',').map(tag => tag.trim() ? `<span class="badge bg-indigo-100 text-indigo-800">${tag.trim()}</span>` : '').join('') : 'Tidak ada tag.';

      // Populate parameters section dynamically
      const paramsSection = document.getElementById('detailParametersSection');
      const paramsContent = document.getElementById('detailParametersContent');
      paramsContent.innerHTML = ''; // Clear previous content

      let hasParameters = false;

      // Helper to add parameter row
      const addParamRow = (label, value, copyValue = value) => {
          if (value !== undefined && value !== null && value !== '') {
              paramsContent.innerHTML += `
                  <div class="flex justify-between items-center">
                      <span><strong>${label}:</strong> <span class="font-normal">${value}</span></span>
                      <i class="fa-solid fa-copy copy-icon" onclick="copyTextToClipboard('${copyValue}')"></i>
                  </div>
              `;
              hasParameters = true;
          }
      };

      // Add common parameters
      addParamRow('Platform', item.platform ? item.platform.charAt(0).toUpperCase() + item.platform.slice(1) : null);
      addParamRow('Model', item.model);
      addParamRow('Negative Prompt', item.negativePrompt);

      // Add Tensor-specific data if available (assuming 'tensorData' is a property for 'tensor' platform)
      if (item.platform === 'tensor' && item.tensorData) {
        const td = item.tensorData;
        addParamRow('VAE', td.vae);
        addParamRow('Sampler', td.sampler);
        addParamRow('Scheduler', td.scheduler);
        addParamRow('Steps', td.steps);
        addParamRow('CFG Scale', td.cfg);
        addParamRow('Seed', td.seed);
        
        if (td.lora && Array.isArray(td.lora) && td.lora.length > 0) {
            let loraHtml = '<div><strong>LoRA:</strong><div class="space-y-1 mt-1">';
            td.lora.forEach((l) => {
                if (l.name && l.name.trim() !== '') {
                    const loraText = `${l.name}: ${l.strength || 'N/A'}`;
                    loraHtml += `
                        <div class="flex justify-between items-center">
                            <span>${loraText}</span>
                            <i class="fa-solid fa-copy copy-icon" onclick="copyTextToClipboard('${loraText}')"></i>
                        </div>
                    `;
                    hasParameters = true;
                }
            });
            loraHtml += '</div></div>';
            paramsContent.innerHTML += loraHtml;
        }

        let badgesHtml = '';
        if (td.upscaler) badgesHtml += `<span class="badge bg-yellow-100 text-yellow-800">Upscaler</span>`;
        if (td.adetailer) badgesHtml += `<span class="badge bg-yellow-100 text-yellow-800">ADetailer</span>`;
        if (badgesHtml) {
            paramsContent.innerHTML += `<div class="mt-2 flex gap-2">${badgesHtml}</div>`;
            hasParameters = true;
        }
      }

      // Show/hide parameters section based on content
      if (hasParameters) {
        paramsSection.classList.remove('hidden');
      } else {
        paramsSection.classList.add('hidden');
      }

      detailModal.classList.remove('hidden');
    };

    const closeDetailModal = () => {
      const detailModal = document.getElementById('detailModal');
      detailModal.classList.add('hidden');
      currentDetailItem = null;
    };
    
    // Fungsi untuk menerapkan filter pencarian
    const applyFilters = () => {
        const searchInput = document.getElementById('searchInput');
        const searchTerm = searchInput.value.toLowerCase();

        const filtered = collections.filter(item => {
            const matchesSearch = searchTerm === '' ||
                (item.prompt && item.prompt.toLowerCase().includes(searchTerm)) ||
                (item.tags && typeof item.tags === 'string' && item.tags.toLowerCase().includes(searchTerm)) ||
                (item.model && item.model.toLowerCase().includes(searchTerm));
            
            return matchesSearch;
        });
        renderGallery(filtered);
    };

    // ===================================================================================
    // INISIALISASI APLIKASI (JALANKAN SETELAH DOM SEPENUHNYA DIMUAT)
    // ===================================================================================
    
    document.addEventListener('DOMContentLoaded', () => {
      // Dapatkan referensi elemen DOM di sini
      const importInput = document.getElementById('importInput');
      const importBtn = document.getElementById('importBtn');
      const fileNameDisplay = document.getElementById('fileNameDisplay');
      const searchInput = document.getElementById('searchInput');
      const viewGrid2x2Btn = document.getElementById('viewGrid2x2');
      const viewGrid3x3Btn = document.getElementById('viewGrid3x3');
      const viewListBtn = document.getElementById('viewList');
      const copyImageUrlBtn = document.getElementById('copyImageUrlBtn');
      const openImageNewTabBtn = document.getElementById('openImageNewTabBtn');

      // Event Listeners
      importBtn.addEventListener('click', () => {
          console.log("Import button clicked.");
          importInput.click();
      });

      importInput.addEventListener('change', function(e) {
        console.log("File input change event triggered.");
        const file = e.target.files[0];
        if (file) {
          console.log("File selected:", file.name);
          fileNameDisplay.textContent = file.name;
          const reader = new FileReader();
          
          reader.onload = function(e) {
            console.log("FileReader onload event triggered.");
            try {
              const importedData = JSON.parse(e.target.result);
              console.log("JSON parsed successfully. Data length:", importedData.length);

              if (Array.isArray(importedData) && importedData.every(d => d.imageUrl && d.prompt)) {
                collections = importedData; // Replace current collections
                renderGallery();
                showToast(`${collections.length} koleksi berhasil diimpor!`);
              } else {
                throw new Error("Format JSON tidak valid. Pastikan ini adalah array objek dengan 'imageUrl' dan 'prompt'.");
              }
            } catch (error) {
              showToast(`Gagal impor: ${error.message}`);
              console.error("Import error:", error);
            }
          }

          reader.onerror = function(error) {
              console.error("FileReader error:", error);
              showToast("Gagal membaca file.");
          };

          reader.readAsText(file);
          this.value = ''; // Reset input file
        } else {
          console.log("No file selected.");
          fileNameDisplay.textContent = 'Belum ada file dipilih.';
        }
      });

      // Handle View Options
      const setView = (view) => {
        currentView = view;
        viewGrid2x2Btn.classList.remove('active');
        viewGrid3x3Btn.classList.remove('active');
        viewListBtn.classList.remove('active');

        if (view === 'grid-2x2') {
          viewGrid2x2Btn.classList.add('active');
        } else if (view === 'grid-3x3') {
          viewGrid3x3Btn.classList.add('active');
        } else if (view === 'list') {
          viewListBtn.classList.add('active');
        }
        applyFilters(); // Re-render with new view
      };

      viewGrid2x2Btn.addEventListener('click', () => setView('grid-2x2'));
      viewGrid3x3Btn.addEventListener('click', () => setView('grid-3x3'));
      viewListBtn.addEventListener('click', () => setView('list'));

      // Handle Search Input
      searchInput.addEventListener('input', applyFilters);

      // Handle Salin URL Gambar
      copyImageUrlBtn.addEventListener('click', function() {
          if (currentDetailItem && currentDetailItem.imageUrl) {
              copyTextToClipboard(currentDetailItem.imageUrl);
              showToast('URL Gambar berhasil disalin!');
          } else {
              showToast('Tidak ada URL gambar untuk disalin.');
          }
      });

      // Handle Buka Gambar di Tab Baru
      openImageNewTabBtn.addEventListener('click', function(e) {
          if (currentDetailItem && currentDetailItem.imageUrl) {
              this.href = currentDetailItem.imageUrl;
          } else {
              e.preventDefault(); // Prevent opening empty tab
              showToast('Tidak ada gambar untuk dibuka.');
          }
      });

      // Initial render with empty collections
      renderGallery();
    });
  </script>
</body>
</html>
